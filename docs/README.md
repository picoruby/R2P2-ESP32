# R2P2-ESP32 設計書・ドキュメント

このディレクトリには、R2P2-ESP32 プロジェクトの詳細な技術設計書とプロンプトが保管されています。

---

## 📄 ドキュメント一覧

### 1. **R2P2-ESP32_Architecture_and_Boot_Sequence.md** （13,000+ 語）

**完全な技術設計書（マークダウン形式）**

**内容:**
- ネストされたサブモジュール構造（3層）
- `rake build` パイプラインの詳細解説
- フラッシュパーティション設計
- ESP32 ブート～REPL プロンプト表示までのシーケンス
- メモリレイアウト・図表・タイムライン
- 実装ファイル参照（行番号付き）
- トラブルシューティング

**用途:**
- ローカルで参照・保存
- IDE で表示
- バージョン管理（Git）に含める
- チームで共有
- ドキュメント生成用ベース

**フォーマット:**
```markdown
# 見出し構造
- セクション番号付き（1-7）
- サブセクション階層化
- テーブル・図表豊富
- コードブロック含む
- 行番号参照可能
```

---

### 2. **claude-web-chat-prompt.md** （コピペ用プロンプト）

**Claude Web Chat でアーティファクト生成用プロンプト**

**内容:**
- 完全なプロンプトテキスト（コピー＆ペーストで使用可能）
- 使用方法（5 ステップ）
- カスタマイズオプション
- 期待される出力形式の説明
- 使用例

**用途:**
- Claude Web Chat（claude.ai）で実行
- アーティファクト形式の設計書を自動生成
- 追加説明や図表の詳細化
- チームメンバーへの共有用

**使用フロー:**
```
1. https://claude.ai を開く
2. このプロンプトをコピー
3. Claude Web Chat に貼り付け
4. 送信
5. アーティファクトが自動生成される
```

---

## 🚀 クイックスタート

### ローカルで設計書を参照

```bash
# マークダウンビューアで開く
cat docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md

# VS Code で開く
code docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md

# GitHub で表示（リポジトリ内）
# https://github.com/...../R2P2-ESP32/blob/main/docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md
```

### Claude Web Chat でアーティファクト生成

```
1. https://claude.ai にアクセス
2. docs/claude-web-chat-prompt.md を開く
3. 「プロンプトテキスト」セクションをコピー
4. Claude Web Chat に貼り付け
5. 送信 → アーティファクト生成！
```

---

## 📋 ドキュメント比較表

| 項目 | 設計書（.md） | Web Chat プロンプト |
|-----|-------------|------------------|
| **形式** | マークダウン | テキスト（コピペ用） |
| **保存** | ローカル・Git | 参照用・共有用 |
| **容量** | 13,000+ 語 | 1,000 語 |
| **更新** | 手動編集 | プロンプト変更で再生成 |
| **図表** | ASCII アート | Markdown |
| **用途** | 参照・ドキュメント | 自動生成・カスタマイズ |
| **アクセス** | オフライン可 | Claude AI 必要 |
| **シェア** | GitHub・Email | プロンプト共有 |

---

## 📖 ドキュメント内容の全体像

### 設計書（R2P2-ESP32_Architecture_and_Boot_Sequence.md）の構成

```
1. サブモジュール・ネスト構造 (1.1-1.2)
   ├─ ディレクトリ階層（図解）
   └─ 各層の役割（テーブル）

2. rake build パイプライン (2.1-2.5)
   ├─ Rakefile 全体構造
   ├─ メインタスク定義
   ├─ 実行フロー
   ├─ idf.py build の内部処理
   │  ├─ ステップ1: PicoRuby ライブラリビルド
   │  ├─ ステップ2: gem の mRuby/c バイトコード化
   │  ├─ ステップ3: main_task.rb のコンパイル
   │  ├─ ステップ4: ESP32 ファームウェアリンク
   │  └─ ステップ5: 出力物の生成
   └─ ビルドチェーン全体図

3. rake flash → monitor フロー (3.1-3.4)
   ├─ フラッシュパーティション設計
   ├─ メモリレイアウト（4MB 図表）
   ├─ rake flash の実行処理
   └─ rake monitor フロー

4. ESP32 ブート～REPL フロー (4.1-4.10)
   ├─ ハードウェアレベルの起動（フローチャート）
   ├─ app_main() エントリーポイント
   ├─ picoruby_esp32() 関数の詳細実装
   ├─ メモリレイアウト（RAM 図表）
   ├─ mrbc_run() の内部動作
   ├─ main_task.rb の実行シーケンス（4フェーズ）
   ├─ Shell.start の処理詳細
   ├─ シリアル出力例
   ├─ ユーザーコマンド実行例
   └─ 完全なタイムライン（325ms で READY）

5. キーポイント・まとめ (5.1-5.5)
   ├─ ネストされたサブモジュールの役割分担（テーブル）
   ├─ ビルドチェーン：複数言語の統合（フロー）
   ├─ 起動フロー：3フェーズ（テーブル）
   ├─ メモリ配置の最適化（図表）
   └─ 3段階のコンパイル（フロー）

6. 実装参照 (6.1-6.3)
   ├─ 主要ファイルパス（テーブル）
   ├─ ビルド環境変数
   └─ 定義済みマクロ

7. トラブルシューティング (7.1-7.3)
   ├─ ビルド失敗時
   ├─ フラッシュ失敗時
   └─ シリアル接続失敗時
```

---

## 🎯 読み方ガイド

### 初心者向け（全体を理解したい）
```
読む順序:
1. セクション 5（キーポイント）で全体像掴む
2. セクション 1（サブモジュール）で構造理解
3. セクション 2（ビルド）で流れ理解
4. セクション 4（ブート）で実行フロー理解
5. セクション 6（実装参照）で詳細確認
```

### 開発者向け（実装を深堀りしたい）
```
読む順序:
1. セクション 2（ビルドパイプライン）
2. セクション 4.3-4.6（実装ファイル詳細）
3. セクション 6（実装参照：行番号付き）
4. セクション 7（トラブルシューティング）
```

### 管理者向け（ビルドシステム管理）
```
読む順序:
1. セクション 2（rake ビルドパイプライン）
2. セクション 3（フラッシュ・モニタ）
3. セクション 6（環境変数・マクロ）
4. セクション 7（トラブルシューティング）
```

---

## 🔍 セクション別クイックリンク

**設計書内でも各セクションは独立して読めます：**

| セクション | 対象者 | 読了時間 |
|----------|--------|--------|
| 1. サブモジュール構造 | 全員 | 5分 |
| 2. ビルドパイプライン | 開発者・管理者 | 15分 |
| 3. フラッシュ・モニタ | 管理者 | 5分 |
| 4. ブートシーケンス | 開発者 | 20分 |
| 5. キーポイント | 全員 | 10分 |
| 6. 実装参照 | 開発者 | 15分 |
| 7. トラブルシューティング | 管理者 | 5分 |

---

## 💡 活用例

### 例1: プロジェクト新規メンバーのオンボーディング

```
1. docs/README.md （このファイル）を読む
2. docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md を読む
   （初心者向け読み方ガイドに従う）
3. 実際に rake build → rake flash → rake monitor を実行
4. REPL でコマンド実行
5. 全体フロー理解完了！
```

### 例2: チームドキュメント共有

```
方法A: ローカル設計書をシェア
  - docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md
  - Git にコミット
  - チーム全員がアクセス可能

方法B: Claude Web Chat でカスタマイズ版生成
  - docs/claude-web-chat-prompt.md を共有
  - 各メンバーが Claude 実行
  - より詳細な説明版を生成・保存

方法C: 両方を使い分け
  - ローカル版 = リファレンス・スナップショット
  - Web Chat版 = 深掘り・詳細説明版
```

### 例3: ドキュメント更新

```
プロジェクト変更 → 設計書更新 → Git コミット

手順:
1. docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md を編集
2. マークダウン書式を保持
3. git add docs/
4. git commit -m "Update: [変更内容]"
5. チームで確認・マージ
```

---

## 📚 推奨される全体的な学習フロー

```
初回訪問
  ↓
[1] README.md（このファイル）
    ↓
    理解: ドキュメント構成・レイアウト
    ↓
[2] R2P2-ESP32_Architecture_and_Boot_Sequence.md
    ↓
    読み方ガイド → 初心者向け順序で読む
    ↓
    理解: 全体構造・ビルド・起動フロー
    ↓
[3] 実際にビルド実行
    $ rake build
    $ rake flash
    $ rake monitor
    ↓
    体験: コンパイル・フラッシュ・REPL
    ↓
[4] 必要に応じて claude-web-chat-prompt.md で詳細化
    ↓
    詳細理解: 実装レベルの深堀り
    ↓
完全習得！
```

---

## 🔧 ドキュメントの保守

### ドキュメント更新時のチェックリスト

```
□ Rakefile 変更時
  └─ セクション 2（ビルドパイプライン）を更新

□ CMakeLists.txt 変更時
  └─ セクション 2（ビルド）を更新

□ main_task.rb 変更時
  └─ セクション 4.6（実行シーケンス）を更新

□ パーティション定義変更時
  └─ セクション 3（フラッシュ）を更新

□ 新しい gem 追加時
  └─ セクション 2.4（gem 定義）を更新

□ マイクロコントローラー型変更時
  └─ セクション全体を見直し
```

### バージョン管理

```
設計書は Git で管理されます：
  docs/R2P2-ESP32_Architecture_and_Boot_Sequence.md
  docs/claude-web-chat-prompt.md
  docs/README.md

コミット例:
  git commit -m "docs: Update build pipeline explanation"
  git commit -m "docs: Fix boot sequence timeline"
  git commit -m "docs: Add new gem definitions"
```

---

## 📞 サポート

### ドキュメント内容について質問がある場合

```
方法1: ローカルで確認
  - docs/ 内のファイルを確認
  - セクション・テーブル・図表を参照

方法2: Claude Web Chat で質問
  - claude-web-chat-prompt.md を実行
  - 生成されたアーティファクトに追記質問

方法3: チームで確認
  - GitHub Issues に質問登録
  - PR でドキュメント改善提案
```

---

## ✅ チェックリスト

このドキュメントを活用する前に、以下を確認してください：

- [ ] R2P2-ESP32 をクローン済み
- [ ] サブモジュール初期化済み（`git submodule update --init --recursive`）
- [ ] ESP-IDF 環境セットアップ済み
- [ ] 最新の rake・Ruby 環境あり
- [ ] このドキュメントを読む時間あり（初回: 60～90分）

---

## 🎉 まとめ

このドキュメント集により、以下が実現できます：

✅ **R2P2-ESP32 プロジェクトの完全理解**
  - ネストされたサブモジュール構造
  - ビルドパイプラインの全体像
  - マイクロコントローラー上での起動フロー
  - REPL インタラクティブ実行環境

✅ **効率的なオンボーディング**
  - 新規メンバーの学習時間短縮
  - チーム全体の知識共有

✅ **継続的な保守性**
  - 設計意図の明確化
  - トラブルシューティング支援
  - ドキュメント版管理

---

**最終更新**: 2025-12-06

**作成ツール**: Claude Code + Claude Haiku 4.5

**形式**: Markdown

**対応**: R2P2-ESP32 最新版（commit 92e9c5b）
